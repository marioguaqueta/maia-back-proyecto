name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2-key.pem
          chmod 600 ~/.ssh/ec2-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # Copy files to EC2
          rsync -avz -e "ssh -i ~/.ssh/ec2-key.pem" \
            --exclude 'general_dataset/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.git/' \
            --exclude 'venv/' \
            --exclude '*.zip' \
            --exclude '*.log' \
            --exclude '*.db' \
            --exclude 'wildlife_detection.db' \
            ./ $EC2_USER@$EC2_HOST:/home/ubuntu/maia-back-proyecto/
          
          # Deploy on EC2
          ssh -i ~/.ssh/ec2-key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            cd /home/ubuntu/maia-back-proyecto
            
            # Stop existing containers
            docker-compose down || true
            
            # Remove old containers and images to free space
            docker system prune -f
            
            # Build and start containers
            docker-compose up -d --build
            
            # Wait for service to start
            echo "Waiting for service to start..."
            sleep 15
            
            # Check container status
            echo "Container status:"
            docker-compose ps
            
            # Show recent logs
            echo "Recent logs:"
            docker-compose logs --tail=30
          ENDSSH
      
      - name: Verify Deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/ec2-key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            # Test the health endpoint
            for i in {1..5}; do
              if curl -f http://localhost:8000/health; then
                echo "Health check passed!"
                exit 0
              fi
              echo "Waiting for service to be ready... ($i/5)"
              sleep 5
            done
            echo "Health check failed!"
            exit 1
          ENDSSH
      
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/ec2-key.pem
      
      - name: Notify Success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "API is now running on http://${{ secrets.EC2_HOST }}:8000"
          echo "Health check: http://${{ secrets.EC2_HOST }}:8000/health"
          echo "Deployed to: /home/ubuntu/maia-back-proyecto"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."

